| **Цели занятия** |

-   Ознакомиться с группировкой данных в SQL-запросах.
-   Ознакомиться с правилами написания с GROUP BY.
-   Рассмотреть примеры агрегатных функций.

 |
| **План занятия** |

-   Группировка данных.
-   Агрегатные функции.
-   Условие HAVING.

 |

* * * * *

Группировка данных

Иногда требуется узнать информацию не о самих объектах, а об определенных группах, которые они образуют. Допустим, у нас есть таблица с погодными данными или клиентами. В ней есть поле с географическими данными --- страны, в которых находятся метеостанции или клиенты. И нас интересует анализ данных в разрезе стран.

В этом случае мы будем применять группировку данных с помощью оператора `GROUP BY`. То есть `GROUP BY` используется для группировки результатов при формировании выборки из базы данных.

**Синтаксис запроса:**

SELECT column_name(s)
FROM table_name
WHERE condition
GROUP BY column_name(s)
ORDER BY column_name(s);

Например, у нас есть информация о клиентах какой-то компании, и мы хотим узнать, в какой стране их больше. В этом случае нам потребуется агрегатная функция `COUNT` (рассмотрим ее чуть позже), после которой указываем таблицу и выполняем группировку по странам:

SELECT COUNT(CustomerID), Country
FROM Customers
GROUP BY Country;

Так мы получим информацию, сколько клиентов совершали покупки в той или иной стране.

Оператор `GROUP BY` используется, когда нам нужно выполнить какие-то преобразования не с записями таблицы, а с группами записей. То есть когда нам нужно узнать какую-то информацию об определенных группах.

Для `GROUP BY` все значения `NULL` (пропуски) трактуются как равные. То есть при группировке по полю, содержащему `NULL`-значения, то все такие строки попадут в одну группу.

Агрегатные функции

Агрегатных функций пять --- *поиск минимума и максимума*, *подсчет значений*, *нахождение суммы и среднего*.

`MIN()` возвращает минимальное значение столбца, название которого передано в качестве аргумента этой функции.

Допустим, у нас есть таблица со следующими данными:

| **Date** | **Temperature** | **Location** | **Country** |
| ---------- | -------------| ------------ | -----------|
| 22.01.2019 | 4.5 | Sydney | Australia |
| 22.01.2019 | -10 | Moscow | Russia |
| 22.02.2019 | 7.8 | Moscow | Russia |
| 22.01.2018 | 11.4 | London | UK |

Применим функцию нахождения минимума к столбцу с данными о температуре:

SELECT MIN(Temperature)
FROM Data;

Такой запрос вернет нам значение минимальной температуры, равное -10.

`MAX()` возвращает максимальное значение столбца.

**Запрос аналогичен предыдущему:**

SELECT MAX(Temperature)
FROM Data;

Результат: 11.4 (максимальная температура).

`COUNT()` возвращает количество записей, т. е. строк таблицы.

**Запрос:**

SELECT COUNT(Temperature)
FROM Data;

Результат: 4 (количество записей в таблице).

Если захотим посчитать количество записей только с положительными значениями, то нужно будет добавить в запрос условие `WHERE` с ограничением температуры больше нуля. В этом случае запрос вернет нам значение 3.

`SUM()` возвращает сумму значений столбца таблицы.

**Запрос:**

SELECT SUM(Temperature)
FROM Data;

Результат: 13.7 (сумма всех значений столбца с температурами).

Также мы можем добавить условие на выбор строк, то есть к `WHERE` прописать какое-то дополнительное условие. Например, посчитать сумму только в разрезе определенного города или страны.

`AVG()` возвращает среднее значение столбца.

**Запрос:**

SELECT AVG(Temperature)
FROM Data;

Результат: 3.425 (средняя температура).

Условие HAVING при группировке данных

Часто возникает необходимость накладывать какие-то ограничения на выборку агрегированных данных. В этом случае мы не можем использовать условие `WHERE`, но можем использовать `HAVING`.

Допустим, мы хотим в итоговой таблице увидеть только те записи, для которых агрегатная функция по полю `CustomerID` больше 5:

SELECT COUNT(CustomerID), Country
FROM Customers
GROUP BY Country
HAVING COUNT(CustomerID) > 5;

Другими словами, этот запрос в агрегированной таблице оставит только те записи, для которых число клиентов было больше пяти.

Добавим к предыдущему примеру сортировку:

SELECT COUNT(CustomerID), Country
FROM Customers
GROUP BY Country
HAVING COUNT(CustomerID) > 5
ORDER BY COUNT(CustomerID) DESC;

После этого строки в итоговой таблице будут выведены в определенном порядке, который мы прописали после оператора `ORDER BY COUNT` --- в порядке убывания числа покупателей.

* * * * *

Итоги занятия:

-   Оператор `GROUP BY` используется для объединения результатов выборки по одному или нескольким столбцам.
-   Агрегатная функция выполняет вычисление на наборе значений и возвращает одиночное значение.
-   К агрегатным функциям относятся функции `MIN()`, `MAX()`, `COUNT()`, `AVG()` и `SUM()`.
-   Если требуется получить информацию не о самих объектах (записях таблицы), а об определенных группах, то для этого используется оператор `GROUP BY` и агрегатные функции.

Источники

-   [Агрегатная функция от агрегатной функции ](http://www.sql-tutorial.ru/ru/book_aggregate_function_to_aggregate_function.html)
-   [Агрегатные функции](https://sql-academy.org/ru/guide/aggregate-functions)
-   [Группировки и оконные функции в Oracle](https://habr.com/ru/post/512336/)